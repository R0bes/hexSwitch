# Docker Compose for example services
# Three services communicating with each other:
# - example1: HTTP Service (port 8000)
# - example2: gRPC Service (port 50051)
# - example3: WebSocket/MCP Service (ports 8080, 3000)
#
# Ports are configured via HEX_ environment variables to avoid duplication:
# - Inbound ports: HEX_INBOUND_<ADAPTER>_PORT
# - Outbound URLs: HEX_OUTBOUND_<ADAPTER>_<URL_FIELD>
# These override values from hex-config.toml files

name: example-services

services:
  example1:
    build:
      context: services/example1
      dockerfile: Dockerfile
    image: ${REGISTRY}/example1:latest
    container_name: example1
    ports:
      - "8000:8000"  # HTTP
    environment:
      - LOG_LEVEL=INFO
      - SERVICE_NAME=example1
      # Inbound adapter ports
      - HEX_INBOUND_HTTP_PORT=8000
      # Outbound adapter URLs (referencing other services)
      - HEX_OUTBOUND_GRPC_CLIENT_SERVER_URL=example2:50051
      - HEX_OUTBOUND_WEBSOCKET_CLIENT_URL=ws://example3:8080
    volumes:
      - ./services/example1/hex-config.toml:/app/hex-config.toml:ro
    networks:
      - example-network
    restart: unless-stopped
    depends_on:
      example2:
        condition: service_started
      example3:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import example_service; print('OK')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  example2:
    build:
      context: services/example2
      dockerfile: Dockerfile
    image: ${REGISTRY}/example2:latest
    container_name: example2
    ports:
      - "50051:50051"  # gRPC
    environment:
      - LOG_LEVEL=INFO
      - SERVICE_NAME=example2
      # Inbound adapter ports
      - HEX_INBOUND_GRPC_PORT=50051
      # Outbound adapter URLs (referencing other services)
      - HEX_OUTBOUND_HTTP_CLIENT_BASE_URL=http://example1:8000
      - HEX_OUTBOUND_WEBSOCKET_CLIENT_URL=ws://example3:8080
    volumes:
      - ./services/example2/hex-config.toml:/app/hex-config.toml:ro
    networks:
      - example-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import example2_service; print('OK')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  example3:
    build:
      context: services/example3
      dockerfile: Dockerfile
    image: ${REGISTRY}/example3:latest
    container_name: example3
    ports:
      - "8080:8080"  # WebSocket
      - "3000:3000"  # MCP
    environment:
      - LOG_LEVEL=INFO
      - SERVICE_NAME=example3
      # Inbound adapter ports
      - HEX_INBOUND_WEBSOCKET_PORT=8080
      - HEX_INBOUND_MCP_PORT=3000
      # Outbound adapter URLs (referencing other services)
      - HEX_OUTBOUND_HTTP_CLIENT_BASE_URL=http://example1:8000
      - HEX_OUTBOUND_GRPC_CLIENT_SERVER_URL=example2:50051
    volumes:
      - ./services/example3/hex-config.toml:/app/hex-config.toml:ro
    networks:
      - example-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import example3_service; print('OK')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  example-network:
    driver: bridge

